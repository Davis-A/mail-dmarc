#!/usr/bin/perl
use strict;
use warnings;

use Data::Dumper;

$|++;
use lib 'lib';
use Mail::DMARC::Report;
my $report = Mail::DMARC::Report->new();

# 1. get list of reports where end < now
while (defined(my $aggregate = $report->store->retrieve ) ) {

    print $aggregate->metadata->domain . "\n";
    print "rua: " . $aggregate->policy_published->rua . "\n";
    my $xml = $aggregate->as_xml();
    $report->sendit->send_rua(\$aggregate, \$xml) # deliver via SMTP/HTTP
        and $report->store->delete_report($aggregate->metadata->report_id);
    print $xml;
    print "sleeping 5";
    foreach ( 1 .. 5 ) { print '.'; sleep 1; };
    print "done.\n";
};

exit;
# PODNAME: dmarc_report
# ABSTRACT: send aggregate reports to requestors
